<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Pseudo-absence and background data</title>

<script src="site_libs/header-attrs-2.17/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Macroecology and global change</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Pracs: macroecological analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="a0_setup.html">0. Getting started</a>
    </li>
    <li>
      <a href="a1_SpatialData.html">1. Spatial data in R</a>
    </li>
    <li>
      <a href="a2_RichnessGradients.html">2. Species richness gradients</a>
    </li>
    <li>
      <a href="a3_RichnessRegression.html">3. Species richness regression</a>
    </li>
    <li>
      <a href="a4_RangeMaps.html">4. Species range maps</a>
    </li>
    <li>
      <a href="a5_SpeciesThreats.html">5. Species threats</a>
    </li>
    <li>
      <a href="a6_BiodivChanges.html">6. Analysing biodiversity changes</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Pracs: species distribution modelling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="b1_SpeciesData.html">1. Species data</a>
    </li>
    <li>
      <a href="b2_EnvData.html">2. Environmental data</a>
    </li>
    <li>
      <a href="b3_SDM_intro.html">3. SDMs: simple model fitting</a>
    </li>
    <li>
      <a href="b4_SDM_eval.html">4. SDMs: assessment and prediction</a>
    </li>
    <li>
      <a href="b5_pseudoabsence.html">5. Pseudo-absence and background data</a>
    </li>
    <li>
      <a href="b6_SDM_algorithms.html">6. SDMs: algorithms</a>
    </li>
    <li>
      <a href="b7_SDM_ensembles.html">7. SDMs: ensembles</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://www.uni-potsdam.de/en/ibb-macroecology/index">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/ZurellLab">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Pseudo-absence and background data</h1>

</div>


<div class="alert alert-info">
<p><strong>RStudio project</strong></p>
<p>Open the RStudio project that we created in the first session. I
recommend to use this RStudio project for the entire course and within
the RStudio project create separate R scripts for each session.</p>
<ul>
<li>Create a new empty R script by going to the tab “File”, select “New
File” and then “R script”</li>
<li>In the new R script, type
<code># Session b5: Pseudo-absence and background data</code> and save
the file in your folder “scripts” within your project folder, e.g. as
“b5_PseudoAbsences.R”</li>
</ul>
</div>
<div id="introduction" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>In the previous sessions, we have worked with very convenient
presence/absence data to train our species distribution models (SDMs).
However, as you have seen when downloading your own GBIF data, we often
have only presence records available. Absence data are also inherently
difficult to get because it requires a very high sampling effort to
classify a species as absent from a location. For plants, we would need
complete inventories of a larger region, e.g. several 100 m plots placed
within larger 1 km sample squares. For birds, we would need several
visits to a specific region within the breeding season. In both cases,
we could still miss some species, meaning that we do not record the
species although present (resulting in a false negative).</p>
<p>But what should we do if absence data are not available? Most SDM
algorithms (except the profile methods, see session 6) need some kind of
absence or background data to contrast the presence data to. There are
different approaches for creating background data or pseudo-absence data
<span class="citation">(Barbet-Massin et al. 2012; Kramer-Schadt et al.
2013; Phillips et al. 2009)</span>, although there is still room for
further developments in this field and more clear-cut recommendations
for users would be certainly useful. Nevertheless, I hope this tutorial
will provide some examples of how to deal with presence-only data. For
advice on how many background/pseudo-absence points you need, please
read <span class="citation">(Barbet-Massin et al. 2012)</span>.</p>
<p>In this session, we look at two major ways of creating
background/pseudo-absence data:</p>
<ul>
<li>random selection of points within study area (including or excluding
the presence locations) <span class="citation">(Barbet-Massin et al.
2012)</span></li>
<li>random selection of points outside of study area <span
class="citation">(Barbet-Massin et al. 2012)</span></li>
</ul>
<p>We will not cover approaches for dealing with sampling bias:</p>
<ul>
<li>accounting for spatial sampling bias using target-group selection
<span class="citation">(Phillips et al. 2009)</span></li>
<li>accounting for spatial sampling bias using inverse distance
weighting <span class="citation">(Kramer-Schadt et al. 2013)</span></li>
</ul>
</div>
<div id="species-presence-data" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Species presence
data</h1>
<!-- ```{r, eval=F, echo=F, message=F, warning=F} -->
<!-- library(raster) -->
<!-- library(dismo) -->
<!-- ac <- data.frame(x=c(10,20),y=c(51,51),occ=1) -->
<!-- coordinates(ac) <- ~x+y -->
<!-- projection(ac) <- CRS('+proj=longlat +datum=WGS84') -->
<!-- acx <- circles(ac, d=500000, lonlat=TRUE) -->
<!-- pol <- polygons(acx) -->
<!-- samp1 <- spsample(pol, 1000, type='random', iter=25) -->
<!-- cells <- cellFromXY(bg, samp1) -->
<!-- cells <- unique(cells) -->
<!-- cells <- cells[!is.na(extract(bg,cells))] -->
<!-- xy <- data.frame(xyFromCell(bg, cells)) -->
<!-- xy$sp <- NA -->
<!-- ac2 <- data.frame(x=c(10,12,13,15,18,20),y=c(51,50,53,52,53,51),occ=1) -->
<!-- coordinates(ac2) <- ~x+y -->
<!-- projection(ac2) <- CRS('+proj=longlat +datum=WGS84') -->
<!-- ac2x <- circles(ac2, d=120000, lonlat=TRUE) -->
<!-- pol2 <- polygons(ac2x) -->
<!-- xy[which(cells %in%  cellFromPolygon(bg,pol2)[[1]]),'sp'] <- 'Populus_imagines' -->
<!-- xy[-which(cells %in%  cellFromPolygon(bg,pol2)[[1]]),'sp'] <- 'Populus_spp' -->
<!-- write.table(xy,file='../data/D4_02_presences.txt',row.names=F) -->
<!-- ``` -->
<p>I created a virtual species data set with presence points for a dummy
species called <em>Populus imagines</em> and sister species <em>Populus
spp</em>. The spatial resolution of the data is 5 minutes. You can
download the data <a href="data/Prac5_data.zip">here</a> or from the
moodle page.</p>
<p>Load and plot the data:</p>
<pre class="r"><code>library(terra)
library(dismo)
library(raster)

region &lt;- terra::rast(&#39;data/Prac5_Europe5min.grd&#39;)
sp &lt;- read.table(&#39;data/Prac5_presences.txt&#39;, header=T)

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(sp[sp$sp==&#39;Populus_spp&#39;,1:2],pch=&#39;+&#39;,cex=0.3,col=&#39;grey20&#39;)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
</div>
<div id="backgroundpseudo-absence-data-selection" class="section level1"
number="3">
<h1><span class="header-section-number">3</span>
Background/Pseudo-absence data selection</h1>
<p>We use a lot of methods from the <code>dismo</code> tutorials, which
are worth looking into (<a
href="https://rspatial.org/raster/sdm/3_sdm_absence-background.html">see
link here</a>) as well as from the <code>terra</code> tutorials (<a
href="https://rspatial.org/terra/sdm/3_sdm_absence-background.html">link
here</a>).</p>
<div
id="random-selection-of-points-within-study-area-but-excluding-the-presence-location"
class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Random selection of
points within study area but excluding the presence location</h2>
<p>The <code>dismo</code> package has a function to sample random points
(background data).</p>
<pre class="r"><code># Randomly select background points from study region
bg_rand &lt;- dismo::randomPoints(raster(region), 500)

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(bg_rand,pch=19,cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>The same could be achieved using the <code>spatSample()</code>
function in <code>terra</code>.</p>
<pre class="r"><code># Random points with terra package:
bg_rand_t &lt;- terra::spatSample(region, 500, as.points=T, na.rm=T)

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(bg_rand_t,pch=19,cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>Both functions will by default sample from the entire study area
independent of the presence points. However, in the
<code>randomPoints()</code> function of the <code>dismo</code> package,
we can provide the presence points as additional argument, and by that
make sure that random background data are not sampled from presence
locations.</p>
<pre class="r"><code># Randomly select background data but excluding presence locations
bg_rand_exclp &lt;- dismo::randomPoints(raster(region), 500, p=sp[sp$sp==&#39;Populus_imagines&#39;,1:2])

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(bg_rand_exclp,pch=19,cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>Also, we can define an extent from where random points should be
drawn. By default, this extent is increased by 5% at each side. To
circumvent this, we set <code>extf=1.0</code>.</p>
<pre class="r"><code># Define extent object:
e &lt;- extent(8,24,46,57)

# Randomly select background data within a restricted extent
bg_rand_exclp_e &lt;- randomPoints(raster(region), 500, p=sp[sp$sp==&#39;Populus_imagines&#39;,1:2], ext=e, extf=1.0)

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(bg_rand_exclp_e,pch=19,cex=0.3)
plot(e, add=TRUE, col=&#39;red&#39;)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>Last, we could also restrict the random samples to within a certain
buffer distance. For this, we first create a <code>SpatVector</code>,
then place a buffer around these and sample from within the buffer. The
buffer can be interpreted as the area that was accessible to the species
in the long-term past. Thus, the buffer helps accounting for
biogeographic history by constraining absence points to those geographic
area that could have been reached by the species given the movement
capacity but excludes other areas. Of course, restricting the absences
to a certain geographic rectangle can achieve a similar tasks but might
be less accurate for complex geographies and large areas. For example,
is Iceland accessible to European species or not?</p>
<pre class="r"><code># Create SpatVector object of known occurrences:
pop_imag &lt;- terra::vect( as.matrix( sp[sp$sp==&#39;Populus_imagines&#39;,1:2]) , crs=crs(region))

# Then, place a buffer of 200 km radius around our presence points
v_buf &lt;- terra::buffer(pop_imag, width=200000)

# Set all raster cells outside the buffer to NA
region_buf &lt;- terra::mask(region, v_buf)

# Randomly select background data within the buffer
bg_rand_buf &lt;- dismo::randomPoints(raster(region_buf), 500)

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
plot(region_buf, legend=F, add=T)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(bg_rand_buf,pch=19,cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
<div id="random-selection-of-points-outside-of-study-area"
class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Random selection of
points outside of study area</h2>
<p><span class="citation">Barbet-Massin et al. (2012)</span> also
suggested a method to sample pseudo-absences only beyond a minimum
distance from the presence points. This is more of a macroecological
approach, suitable for characterising the climatic limits of species. We
can also use the buffering approach from above to achieve this.</p>
<pre class="r"><code># Place a buffer of 200 km radius around our presence points
v_buf &lt;- terra::buffer(pop_imag, width=200000)

# Set all raster cells outside the buffer to NA
region_buf &lt;- terra::mask(region, v_buf)

# Now, we set all the buffer cells in the mask to NA
region_outbuf &lt;- region
values(region_outbuf)[values(region_buf)==1 &amp; !is.na(values(region_buf))] &lt;- NA

# Randomly select background data outside the buffer
bg_rand_outbuf &lt;- dismo::randomPoints(raster(region_outbuf), 500)

# Plot the map and data
plot(region,col=&#39;grey&#39;,legend=F)
plot(region_buf,legend=F, add=T)
points(sp[sp$sp==&#39;Populus_imagines&#39;,1:2],pch=&#39;+&#39;,col=&#39;red&#39;)
points(bg_rand_outbuf,pch=19,cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<!-- ## Accounting for spatial sampling bias using target-group selection -->
<!-- A critical assumption behind the above-mentioned background/pseudo-absence sampling is that the presence points were systematically or randomly sampled from the known distribution and are not spatially biased. In practice, this assumption is often violated, for example when observers go to more easily accessible areas. @Phillips2009 suggested a target-group sampling for this. The idea is that we use the presence points of other groups of species as potential pseudo-absence points to mimic survey effort. These target groups should be collected or observed using the same methods and equipments. So, this approach is kind of assuming that no complete inventories were made by the observers but that there is a chance that if the species had been there it would have been observed along with the others. -->
<!-- Here, we use the sister populus species as target group. -->
<!-- ```{r message=F, warning=F} -->
<!-- # Randomly select background points from the target group -->
<!-- p <- sample(seq_len(nrow(sp[sp$sp=='Populus_spp',])), 500) -->
<!-- bg_target <- sp[sp$sp=='Populus_spp',1:2][p,] -->
<!-- # Plot the map and data -->
<!-- plot(mask,col='grey',legend=F) -->
<!-- points(sp[sp$sp=='Populus_imagines',1:2],pch='+',col='red') -->
<!-- points(bg_target,pch=19,cex=0.3) -->
<!-- ``` -->
<!-- ## Accounting for spatial sampling bias using inverse distance weighting -->
<!-- In the last example, we manipulate the background to have the same sampling bias as the presence data [@Kramer-Schadt2013]. For example, this is particularly useful if presence records are restricted to easily accessible areas like roads. We use inverse distance weighting to define the sampling density of the presence points and then sample background proportional to that density. Following @Kramer-Schadt2013, we assume a low sampling effort outside the sampling range of the presence data - here a 5% sampling effort. -->
<!-- ```{r message=F, warning=F} -->
<!-- # Compute inverse distance weighted interpolation and create raster with density layer -->
<!-- idw <- geoIDW(as.matrix(sp[sp$sp=='Populus_imagines',1:2]),  -->
<!--               randomPoints(mask, sum(sp$sp=='Populus_imagines'))) -->
<!-- idw_r <- predict(mask, idw) -->
<!-- # Re-classify density values below 0.05 indicating a 1/20 of the sampling effort -->
<!-- values(idw_r)[values(idw_r) < 0.05] <- 0.05 -->
<!-- # Clip to land mass -->
<!-- idw_r <- mask(idw_r,mask) -->
<!-- # Randomly select background data proportional to sampling density in presence data -->
<!-- bg_idw <- randomPoints(idw_r, 500, prob=T) -->
<!-- # Plot the map and data -->
<!-- plot(idw_r) -->
<!-- points(sp[sp$sp=='Populus_imagines',1:2],pch='+',col='red') -->
<!-- points(bg_idw,pch=19,cex=0.3) -->
<!-- ``` -->
</div>
</div>
<div
id="workflow-for-joining-presence-and-backgroundpseudo-absence-data"
class="section level1" number="4">
<h1><span class="header-section-number">4</span> Workflow for joining
presence and background/pseudo-absence data</h1>
<p>In session b2, we have already learned how to join species data and
environmental data (at 10 min resolution) using the Alpine Shrew as
example species. Here, we will revisit this example, sample random
background data and join these with environmental data to come up with a
dataset containing presences and background data as well as the climatic
predictors.</p>
<pre class="r"><code># Load the species presence data (here, the data set from session 1):
load(&#39;data/gbif_shrew_cleaned.RData&#39;)

head(gbif_shrew_cleaned[,1:4])</code></pre>
<pre><code>##          key             scientificName decimalLatitude decimalLongitude
## 1 3824140382 Sorex alpinus Schinz, 1837        48.65200         8.358008
## 2 3784645455 Sorex alpinus Schinz, 1837        46.75777        11.317498
## 3 3873231122 Sorex alpinus Schinz, 1837        46.54926        10.625149
## 4 3881729801 Sorex alpinus Schinz, 1837        47.54320        10.693369
## 5 3892282027 Sorex alpinus Schinz, 1837        46.56076         6.107981
## 6 3902041214 Sorex alpinus Schinz, 1837        47.14652        12.712957</code></pre>
<pre class="r"><code># Plot the species presences
library(maptools)
data(wrld_simpl)

plot(wrld_simpl,xlim=c(-12,45), ylim=c(35,73))
points(gbif_shrew_cleaned$decimalLongitude, gbif_shrew_cleaned$decimalLatitude, col=&#39;red&#39;,  pch=19)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>You have already downloaded the climate data in session 2 and can
simply read it back in. We crop it to European extent.</p>
<pre class="r"><code>library(geodata)

# Download global bioclimatic data from worldclim (you may have to set argument &#39;download=T&#39; for first download, if &#39;download=F&#39; it will attempt to read from file):
clim &lt;- geodata::worldclim_global(var = &#39;bio&#39;, res = 10, download = F, path = &#39;data&#39;)

# Crop to Europe
clim &lt;- terra::crop(clim, c(-12,45,35,73))</code></pre>
<p>What is important to consider is that you kind of arbitrarily chose a
scale of analysis by chosing climate data (or other environmental data)
at a certain spatial resolution. Here, we chose a spatial resolution of
10 minutes while the species data may actually be at a finer resolution.
So, we first make sure that our species data are fit to the spatial
resolution, meaning we remove any duplicates within 10 minute cells. We
do this by joining the species data with the environmental data
(basically, repeating what we had already done at the end of session 2).
Then, we can remove the duplicate cells.</p>
<pre class="r"><code># We have already extracted environmental data and raster cellnumbers for the species data
# Remember to remove any rows with duplicate cellnumbers if necessary:
duplicated(gbif_shrew_cleaned$cells)</code></pre>
<pre><code>## logical(0)</code></pre>
<pre class="r"><code># From now on, we just need the coordinates:
gbif_shrew2 &lt;- gbif_shrew_cleaned[,c(&#39;decimalLongitude&#39;,&#39;decimalLatitude&#39;)]</code></pre>
<p>We place a buffer of 200 km around the shrew records and sample
background points randomly from within the buffer but excluding presence
locations (remember that also other pseudo-absence/background data
strategies are possible).</p>
<pre class="r"><code># Make SpatVector:
presences &lt;- terra::vect( as.matrix(gbif_shrew2), crs=crs(clim))

# Then, place a buffer of 200 km radius around our presence points
v_buf &lt;- terra::buffer(presences, width=200000)

# Create a background mask with target resolution and extent from climate layers
# Set all raster cells outside the buffer to NA.
bg &lt;- clim[[1]]
values(bg)[!is.na(values(bg))] &lt;- 1
region_buf &lt;- terra::mask(bg, v_buf)
plot(bg, col=&#39;grey90&#39;, legend=F)
plot(region_buf, add=T, col=&#39;grey60&#39;, legend=F)

# Randomly select background data within the buffer, excluding presence locations. We sample 10 times as many background data as we have presences.
bg_rand_buf &lt;- dismo::randomPoints(raster(region_buf), length(presences)*10, p=gbif_shrew2)</code></pre>
<pre><code>## Warning in dismo::randomPoints(raster(region_buf), length(presences) * 10, :
## generated random points = 0.952272727272727 times requested number</code></pre>
<pre class="r"><code>points(bg_rand_buf, pch=19, cex=0.2)
points(presences, pch=19, cex=0.5, col=&#39;red&#39;)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>Last, we need to join the presences and background data, and extract
the environmental data.</p>
<pre class="r"><code># First, we prepare the presences data to contain a column indicating 1 for presence.
sp_env &lt;- data.frame(gbif_shrew2, occ=1)

# Second, we make sure the background data have the same columns, and indicate 0 for absence.
bg_rand_buf &lt;- data.frame(bg_rand_buf)
summary(bg_rand_buf)</code></pre>
<pre><code>##        x               y        
##  Min.   : 2.75   Min.   :40.92  
##  1st Qu.: 7.75   1st Qu.:45.08  
##  Median :11.25   Median :47.08  
##  Mean   :10.92   Mean   :47.06  
##  3rd Qu.:14.08   3rd Qu.:49.08  
##  Max.   :18.58   Max.   :52.58</code></pre>
<pre class="r"><code>names(bg_rand_buf) &lt;- c(&#39;decimalLongitude&#39;,&#39;decimalLatitude&#39;)
bg_rand_buf$occ &lt;- 0
summary(bg_rand_buf)</code></pre>
<pre><code>##  decimalLongitude decimalLatitude      occ   
##  Min.   : 2.75    Min.   :40.92   Min.   :0  
##  1st Qu.: 7.75    1st Qu.:45.08   1st Qu.:0  
##  Median :11.25    Median :47.08   Median :0  
##  Mean   :10.92    Mean   :47.06   Mean   :0  
##  3rd Qu.:14.08    3rd Qu.:49.08   3rd Qu.:0  
##  Max.   :18.58    Max.   :52.58   Max.   :0</code></pre>
<pre class="r"><code># Third, we bind these two data sets
sp_env &lt;- rbind(sp_env, bg_rand_buf)
summary(sp_env)</code></pre>
<pre><code>##  decimalLongitude decimalLatitude      occ         
##  Min.   : 2.750   Min.   :40.92   Min.   :0.00000  
##  1st Qu.: 7.583   1st Qu.:45.25   1st Qu.:0.00000  
##  Median :10.917   Median :46.92   Median :0.00000  
##  Mean   :10.762   Mean   :47.02   Mean   :0.09503  
##  3rd Qu.:13.750   3rd Qu.:48.75   3rd Qu.:0.00000  
##  Max.   :18.583   Max.   :52.58   Max.   :1.00000</code></pre>
<pre class="r"><code># Last, we join this combined data set with the climate data.
sp_env &lt;- cbind(sp_env, terra::extract(x = clim, y = sp_env[,c(&#39;decimalLongitude&#39;,&#39;decimalLatitude&#39;)], cells=T) )
summary(sp_env)</code></pre>
<pre><code>##  decimalLongitude decimalLatitude      occ                ID      
##  Min.   : 2.750   Min.   :40.92   Min.   :0.00000   Min.   :   1  
##  1st Qu.: 7.583   1st Qu.:45.25   1st Qu.:0.00000   1st Qu.:1042  
##  Median :10.917   Median :46.92   Median :0.00000   Median :2084  
##  Mean   :10.762   Mean   :47.02   Mean   :0.09503   Mean   :2084  
##  3rd Qu.:13.750   3rd Qu.:48.75   3rd Qu.:0.00000   3rd Qu.:3126  
##  Max.   :18.583   Max.   :52.58   Max.   :1.00000   Max.   :4167  
##  wc2.1_10m_bio_1  wc2.1_10m_bio_2  wc2.1_10m_bio_3 wc2.1_10m_bio_4
##  Min.   :-3.347   Min.   : 5.193   Min.   :24.74   Min.   :464.7  
##  1st Qu.: 7.577   1st Qu.: 8.075   1st Qu.:31.28   1st Qu.:624.6  
##  Median : 8.938   Median : 8.561   Median :32.60   Median :658.0  
##  Mean   : 8.916   Mean   : 8.593   Mean   :32.62   Mean   :666.7  
##  3rd Qu.:10.579   3rd Qu.: 9.182   3rd Qu.:33.87   3rd Qu.:706.1  
##  Max.   :16.905   Max.   :11.446   Max.   :41.01   Max.   :819.1  
##  wc2.1_10m_bio_5  wc2.1_10m_bio_6   wc2.1_10m_bio_7 wc2.1_10m_bio_8 
##  Min.   : 7.883   Min.   :-13.749   Min.   :18.97   Min.   :-6.303  
##  1st Qu.:21.878   1st Qu.: -4.501   1st Qu.:24.88   1st Qu.: 9.516  
##  Median :23.524   Median : -2.989   Median :26.09   Median :14.251  
##  Mean   :23.407   Mean   : -2.916   Mean   :26.32   Mean   :12.467  
##  3rd Qu.:25.832   3rd Qu.: -1.126   3rd Qu.:27.67   3rd Qu.:16.568  
##  Max.   :31.365   Max.   :  8.387   Max.   :32.22   Max.   :21.641  
##  wc2.1_10m_bio_9   wc2.1_10m_bio_10 wc2.1_10m_bio_11  wc2.1_10m_bio_12
##  Min.   :-9.6958   Min.   : 3.722   Min.   :-9.7354   Min.   : 217.0  
##  1st Qu.: 0.9651   1st Qu.:15.857   1st Qu.:-0.7275   1st Qu.: 715.0  
##  Median : 3.4396   Median :17.214   Median : 0.6776   Median : 852.0  
##  Mean   : 5.5439   Mean   :17.213   Mean   : 0.9196   Mean   : 915.8  
##  3rd Qu.: 6.3193   3rd Qu.:19.303   3rd Qu.: 2.6122   3rd Qu.:1082.0  
##  Max.   :24.3333   Max.   :24.333   Max.   :11.0833   Max.   :2334.0  
##  wc2.1_10m_bio_13 wc2.1_10m_bio_14 wc2.1_10m_bio_15 wc2.1_10m_bio_16
##  Min.   : 28.0    Min.   :  4.00   Min.   : 4.41    Min.   : 77.0   
##  1st Qu.: 83.0    1st Qu.: 36.00   1st Qu.:16.23    1st Qu.:226.0   
##  Median :100.0    Median : 49.00   Median :23.09    Median :269.0   
##  Mean   :107.5    Mean   : 50.18   Mean   :23.91    Mean   :295.8   
##  3rd Qu.:126.0    3rd Qu.: 61.00   3rd Qu.:30.10    3rd Qu.:345.0   
##  Max.   :278.0    Max.   :119.00   Max.   :61.70    Max.   :743.0   
##  wc2.1_10m_bio_17 wc2.1_10m_bio_18 wc2.1_10m_bio_19      cell      
##  Min.   : 25.0    Min.   : 31.0    Min.   : 36.0    Min.   :41864  
##  1st Qu.:126.0    1st Qu.:195.0    1st Qu.:146.0    1st Qu.:49690  
##  Median :164.0    Median :229.0    Median :189.0    Median :53464  
##  Mean   :170.5    Mean   :252.7    Mean   :198.7    Mean   :53285  
##  3rd Qu.:206.0    3rd Qu.:290.0    3rd Qu.:241.0    3rd Qu.:56898  
##  Max.   :438.0    Max.   :573.0    Max.   :526.0    Max.   :65823</code></pre>
<div id="spatial-thinning" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Spatial thinning</h2>
<p>When we prepare our distribution data for species distribution
modelling, we also need to think about spatial autocorrelation. Using
adjacent cells in model building can lead to problems with spatial
autocorrelation. As a rule of thumb, data points should be at least 2-3
cells apart.</p>
<p>One way to avoid this is spatially thinning the records, for example
using the package <code>spThin</code> <span
class="citation">(Aiello-Lammens et al. 2015)</span>. Load the package
and look up the help page <code>?thin</code>.</p>
<pre class="r"><code>library(spThin)

# The spThin package requires longitude/latitude coordinates, which we already have.
# Look up the help page and try to understand the function:
?thin

# thin() expects that the data.frame contains a column with the species name
sp_env$sp &lt;- &#39;Sorex_alpinus&#39;
  
# Remove adjacent cells of presence/background data:
xy &lt;- thin(sp_env, lat.col=&#39;decimalLatitude&#39;,long.col=&#39;decimalLongitude&#39;,spec.col=&#39;sp&#39;, thin.par=30,reps=1, write.files=F,locs.thinned.list.return=T)</code></pre>
<pre><code>## ********************************************** 
##  Beginning Spatial Thinning.
##  Script Started at: Fri Dec 23 12:27:36 2022
## lat.long.thin.count
## 758 
##   1 
## [1] &quot;Maximum number of records after thinning: 758&quot;
## [1] &quot;Number of data.frames with max records: 1&quot;
## [1] &quot;No files written for this run.&quot;</code></pre>
<pre class="r"><code># Keep the coordinates with the most presence records
xy_keep &lt;- xy[[1]]

# Thin the dataset - here, we first extract the cell numbers for the thinned coordinates and then use these to subset our data frame.
cells_thinned &lt;- terra::cellFromXY(clim, xy_keep)
sp_thinned &lt;- sp_env[sp_env$cell %in% cells_thinned,]

# Plot the map and data
plot(bg, col=&#39;grey90&#39;, legend=F)
points(sp_thinned[,1:2],pch=19,col=c(&#39;black&#39;,&#39;red&#39;)[as.factor(sp_thinned$occ)], cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<!-- ```{r eval=F, echo=F} -->
<!-- # Alternatively, remove adjacent cells separately in presence data and background data: -->
<!-- xy_pres <- thin(sp_env[sp_env$occ==1,], lat.col='decimalLatitude',long.col='decimalLongitude',spec.col='sp', thin.par=20,reps=5, write.files=F,locs.thinned.list.return=T) -->
<!-- xy_pres_keep <- xy_pres[[which.max(sapply(xy_pres,nrow))]] -->
<!-- xy_abs <- thin(sp_env[sp_env$occ==0,], lat.col='decimalLatitude',long.col='decimalLongitude',spec.col='sp', thin.par=20,reps=5, write.files=F,locs.thinned.list.return=T) -->
<!-- xy_abs_keep <- xy_abs[[which.max(sapply(xy_abs,nrow))]] -->
<!-- # Thin the dataset - here, we first extract the cell numbers for the thinned coordinates and then use these to subset our data frame. -->
<!-- cells_thinned2 <- cellFromXY(clim, rbind(xy_pres_keep, xy_abs_keep)) -->
<!-- sp_thinned2 <- sp_env[sp_env$cells %in% cells_thinned2,] -->
<!-- # Plot the map and data -->
<!-- plot(mask, col='grey90', legend=F) -->
<!-- points(sp_thinned2[,1:2],pch=19,col=c('black','red')[as.factor(sp_thinned2$occ)], cex=0.3) -->
<!-- ``` -->
<p>Finally, don’t forget to save your data, for example by writing the
final data frame to file or by saving the R object(s).</p>
<pre class="r"><code>save(sp_thinned,file=&#39;data/gbif_shrew_PresAbs_thinned.RData&#39;)</code></pre>
<p><strong>Alternative:</strong> The <code>thin()</code> function can
take quite long and needs a lot of memory space. A useful alternative
function for spatial thinning is <code>gridSample()</code> in the
<code>dismo</code> package.</p>
<pre class="r"><code>xy &lt;- dismo::gridSample(sp_env[,c(&quot;decimalLongitude&quot;,&quot;decimalLatitude&quot;)], bg,chess=&#39;white&#39;)
sp_thinned2 &lt;- merge(xy,sp_env,by=c(&quot;decimalLongitude&quot;,&quot;decimalLatitude&quot;))

# Plot the map and data
plot(region, col=&#39;grey90&#39;, legend=F)
points(sp_thinned2[,1:2],pch=19,col=c(&#39;black&#39;,&#39;red&#39;)[as.factor(sp_thinned2$occ)], cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<pre class="r"><code>#-----

# Thinning to larger grid
xy &lt;- dismo::gridSample(sp_env[,c(&quot;decimalLongitude&quot;,&quot;decimalLatitude&quot;)], aggregate(bg,2), chess=&#39;white&#39;)
sp_thinned3 &lt;- merge(xy,sp_env,by=c(&quot;decimalLongitude&quot;,&quot;decimalLatitude&quot;))

# Plot the map and data
plot(region, col=&#39;grey90&#39;, legend=F)
points(sp_thinned3[,1:2],pch=19,col=c(&#39;black&#39;,&#39;red&#39;)[as.factor(sp_thinned2$occ)], cex=0.3)</code></pre>
<p><img src="b5_pseudoabsence_files/figure-html/unnamed-chunk-16-2.png" width="672" /></p>
<!-- <div class="alert alert-info"> -->
<!-- _**Exercise:**_ -->
<!-- We have now finished our first own dataset.  -->
<!-- - Use the data and build a GLM for the alpine shrew. Remember the different steps of checking for multicollinearity, building the full model and simplifying it.  -->
<!-- - Assess the predictive performance of that model. -->
<!-- - Make predictions to current climate. Where is the species predicted to occur in Europe? -->
<!-- </div> -->
<div class="alert alert-info">
<p><em><strong>Exercise:</strong></em></p>
<p>In practical b1, you have downloaded your own GBIF data. Carry out
the pseudo-absence data selection for this species, and run a GLM
analysis.</p>
<ul>
<li>Decide on a pseudo-absence/background data strategy for your species
(in the simplest case, just follow the strategy used in the example
workflow in section 4). Prepare your dataset with presences,
pseudo-absences and the corresponding climate data at those locations
(following the workflow in section 4)</li>
<li>Use the data and build a GLM. Remember the different steps of
checking for multicollinearity, building the full model and simplifying
it.</li>
<li>Assess the predictive performance of that model.</li>
<li>Make predictions to current climate. Decide whether you want to make
predictions to the entire globe or to a more restricted geographic area
(e.g. the continent where your species occurs)?</li>
</ul>
</div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Aiello-Lammens2015" class="csl-entry">
Aiello-Lammens, M. E., R. A. Boria, A. Radosavljevic, B. Vilela, and R.
P. Anderson. 2015. <span>“<span class="nocase">spThin</span>: An r
Package for Spatial Thinning of Species Occurrence Records for Use in
Ecological Niche Models.”</span> <em>Ecography</em> 38 (5): 541–45. <a
href="https://doi.org/10.1111/ecog.01132">https://doi.org/10.1111/ecog.01132</a>.
</div>
<div id="ref-BarbetMassin2012a" class="csl-entry">
Barbet-Massin, M., F. Jiguet, C. H. Albert, and W. Thuiller. 2012.
<span>“Selecting Pseudo-Absences for Species Distribution Models: How,
Where and How Many?”</span> <em>Methods in Ecology and Evolution</em> 3
(2): 327–38. <a
href="https://doi.org/10.1111/j.2041-210X.2011.00172.x">https://doi.org/10.1111/j.2041-210X.2011.00172.x</a>.
</div>
<div id="ref-Kramer-Schadt2013" class="csl-entry">
Kramer-Schadt, S., J. Niedballa, J. D. Pilgrim, B. Schroeder, J.
Lindenborn, V. Reinfelder, M. Stillfried, et al. 2013. <span>“The
Importance of Correcting for Sampling Bias in MaxEnt Species
Distribution Models.”</span> <em>Diversity and Distributions</em> 19
(11): 1366–79. <a
href="https://doi.org/10.1111/ddi.12096">https://doi.org/10.1111/ddi.12096</a>.
</div>
<div id="ref-Phillips2009" class="csl-entry">
Phillips, S. J., M. Dudik, J. Elith, C. H. Graham, A. Lehmann, J.
Leathwick, and S. Ferrier. 2009. <span>“Sample Selection Bias and
Presence-Only Distribution Models: Implications for Background and
Pseudo-Absence Data.”</span> <em>Ecological Applications</em> 19 (1):
181–97. <a
href="https://doi.org/10.1890/07-2153.1">https://doi.org/10.1890/07-2153.1</a>.
</div>
</div>
</div>

<!DOCTYPE html>
<html>

<br>
<hr />
<div id="footer">
<p>Damaris Zurell 2022 <a href="http://creativecommons.org/licenses/by/4.0/" >(CC BY 4.0)</a>.  </p>
</div>

</html>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
