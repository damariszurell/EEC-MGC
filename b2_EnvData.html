<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Environmental data</title>

<script src="site_libs/header-attrs-2.26/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Macroecology and global change</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Pracs: macroecological analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="a0_setup.html">0. Getting started</a>
    </li>
    <li>
      <a href="a1_SpatialData.html">1. Spatial data in R</a>
    </li>
    <li>
      <a href="a2_RichnessGradients.html">2. Species richness gradients</a>
    </li>
    <li>
      <a href="a3_RichnessRegression.html">3. Species richness regression</a>
    </li>
    <li>
      <a href="a4_RangeMaps.html">4. Species range maps</a>
    </li>
    <li>
      <a href="a5_SpeciesThreats.html">5. Species threats</a>
    </li>
    <li>
      <a href="a6_BiodivChanges.html">6. Analysing biodiversity changes</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Pracs: species distribution modelling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="b1_SpeciesData.html">1. Species data</a>
    </li>
    <li>
      <a href="b2_EnvData.html">2. Environmental data</a>
    </li>
    <li>
      <a href="b3_SDM_intro.html">3. SDMs: simple model fitting</a>
    </li>
    <li>
      <a href="b4_SDM_eval.html">4. SDMs: assessment and prediction</a>
    </li>
    <li>
      <a href="b5_pseudoabsence.html">5. Pseudo-absence and background data</a>
    </li>
    <li>
      <a href="b6_SDM_algorithms.html">6. SDMs: algorithms</a>
    </li>
    <li>
      <a href="b7_SDM_ensembles.html">7. SDMs: ensembles</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://www.uni-potsdam.de/en/ibb-macroecology/index">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/ZurellLab">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Environmental data</h1>

</div>


<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<hr />
<div class="alert alert-info">
<p><strong>RStudio project</strong></p>
<p>Open the RStudio project that we created in the first session. I
recommend to use this RStudio project for the entire course and within
the RStudio project create separate R scripts for each session.</p>
<ul>
<li>Create a new empty R script by going to the tab “File”, select “New
File” and then “R script”</li>
<li>In the new R script, type
<code># Session b2: Environmental data</code> and save the file in your
folder “scripts” within your project folder, e.g. as “b2_EnvData.R”</li>
</ul>
</div>
<p>In species distribution modelling, we aim to understand how species’
occurrence are related to environment. Thus, additional to our species
data, we need environmental information. Many environmental data are now
available at very high spatial resolution, e.g. lidar data <span
class="citation">(Bakx et al. 2019)</span>. However, often, high
resolution data are not necessarily available globally - although the
data are constantly improving. I can’t give you a full overview over all
available data sets. Rather, you should get an idea how you process the
data to make best use of them for your biodiversity models.</p>
<div id="climate-data" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Climate data</h1>
<p>The <code>geodata</code> package is offering direct access to some
standard repositories; see the help pages <code>?geodata</code>. We will
use this for extracting climate data from the worldclim data base (<a
href="http://worldclim.org/" class="uri">http://worldclim.org/</a>)<span
class="citation">(Hijmans et al. 2005)</span>. Please note that also
other climatologies exist, e.g. the Chelsa climatologies (<a
href="http://chelsa-climate.org/"
class="uri">http://chelsa-climate.org/</a>)<span
class="citation">(Karger et al. 2017)</span>. However, we here stick to
the data offered through the <code>geodata</code> package.</p>
<div id="current-climate" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Current climate</h2>
<p>First, we download the 19 bioclimatic variables at a 10’ resolution,
following the same procedure as in <a
href="https://damariszurell.github.io/EEC-MGC/a1_SpatialData.html">practical
a1</a>. Do you remember what the 19 bioclimatic variables are? See here:
<a href="https://www.worldclim.org/data/bioclim.html"
class="uri">https://www.worldclim.org/data/bioclim.html</a>. Remember to
think about your folder structure, where you want to store the climate
data!</p>
<pre class="r"><code>library(geodata)

# Download global bioclimatic data from worldclim (you may have to set argument &#39;download=T&#39; for first download, if &#39;download=F&#39; it will attempt to read from file):
clim &lt;- geodata::worldclim_global(var = &#39;bio&#39;, res = 10, download = F, path = &#39;data&#39;)

# Now, let&#39;s look at the data:
clim</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 1080, 2160, 19  (nrow, ncol, nlyr)
## resolution  : 0.1666667, 0.1666667  (x, y)
## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## coord. ref. : lon/lat WGS 84 (EPSG:4326) 
## sources     : wc2.1_10m_bio_1.tif  
##               wc2.1_10m_bio_2.tif  
##               wc2.1_10m_bio_3.tif  
##               ... and 16 more source(s)
## names       : wc2.1~bio_1, wc2.1~bio_2, wc2.1~bio_3, wc2.1~bio_4, wc2.1~bio_5, wc2.1~bio_6, ... 
## min values  :   -54.72435,     1.00000,    9.131122,       0.000,   -29.68600,   -72.50025, ... 
## max values  :    30.98764,    21.14754,  100.000000,    2363.846,    48.08275,    26.30000, ...</code></pre>
<pre class="r"><code># Can you explain, what a raster stack is?
plot(clim)</code></pre>
<p><img src="b2_EnvData_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Remember that the <code>terra</code> package offers different
functionalities to manipulate the spatial data, for example aggregating
the data to coarser resolutions (<code>aggregate</code>), cropping
(<code>crop()</code>), and adding spatial layers to a
<code>SpatRaster</code> object (<code>c()</code>):</p>
<pre class="r"><code>terra::aggregate(clim[[1]], fact=6, fun=&quot;mean&quot;)</code></pre>
</div>
<div id="future-climate-scenarios" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Future climate
scenarios</h2>
<p>The Chelsa and worldclim data bases also offer downscaled climate
scenarios. The scenarios stem from the World Climate Research Programme
Coupled Model Intercomparison Projects (CMIPs). The most recent is the
CMIP6 and the corresponding scenarios can be downloaded form the Chelsa
or worlclim websites. For the latter, the downscaled climate scenarios
are again accessible through the <code>geodata</code> package
(<code>?geodata::cmip6_world</code>). In the function
<code>geodata::cmip6_world()</code>, we have to indicate which
<code>model</code> (global circulation model, GCM) we want to download,
which <code>ssp</code> (<a
href="https://www.carbonbrief.org/cmip6-the-next-generation-of-climate-models-explained/">shared
socioeconomic pathway, SSP</a>) and which <code>time</code> period
(projection period; e.g., 2041-2060). More information on the model
abbreviations and the available SSPs can be found here: <a
href="https://www.worldclim.org/data/cmip6/cmip6_clim10m.html"
class="uri">https://www.worldclim.org/data/cmip6/cmip6_clim10m.html</a>.
As above, we have to provide <code>var</code> and <code>res</code>
arguments as well.</p>
<pre class="r"><code># Download future climate scenario from &#39;ACCESS-ESM1-5&#39; climate model.
# Please note that you have to set download=T if you haven&#39;t downloaded the data before:
clim_fut &lt;- geodata::cmip6_world(model=&#39;ACCESS-ESM1-5&#39;, ssp=&#39;245&#39;, time=&#39;2041-2060&#39;, var=&#39;bioc&#39;, download=F, res=10, path=&#39;data&#39;)

# Inspect the SpatRaster object:
clim_fut</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 1080, 2160, 19  (nrow, ncol, nlyr)
## resolution  : 0.1666667, 0.1666667  (x, y)
## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## coord. ref. : lon/lat WGS 84 (EPSG:4326) 
## source      : wc2.1_10m_bioc_ACCESS-ESM1-5_ssp245_2041-2060.tif 
## names       : bio01, bio02, bio03,  bio04, bio05, bio06, ... 
## min values  : -52.8,   0.0,   0.3,   11.1, -28.1, -70.2, ... 
## max values  :  33.3,  21.5,  94.7, 2299.4,  51.7,  26.2, ...</code></pre>
<p>We see that the current and future climate <code>SpatRaster</code>
objects have different layer names. This could cause problems in
distribution modelling and we thus want make sure that they all have the
same layer names.</p>
<pre class="r"><code># Inspect layer names
names(clim)</code></pre>
<pre><code>##  [1] &quot;wc2.1_10m_bio_1&quot;  &quot;wc2.1_10m_bio_2&quot;  &quot;wc2.1_10m_bio_3&quot;  &quot;wc2.1_10m_bio_4&quot; 
##  [5] &quot;wc2.1_10m_bio_5&quot;  &quot;wc2.1_10m_bio_6&quot;  &quot;wc2.1_10m_bio_7&quot;  &quot;wc2.1_10m_bio_8&quot; 
##  [9] &quot;wc2.1_10m_bio_9&quot;  &quot;wc2.1_10m_bio_10&quot; &quot;wc2.1_10m_bio_11&quot; &quot;wc2.1_10m_bio_12&quot;
## [13] &quot;wc2.1_10m_bio_13&quot; &quot;wc2.1_10m_bio_14&quot; &quot;wc2.1_10m_bio_15&quot; &quot;wc2.1_10m_bio_16&quot;
## [17] &quot;wc2.1_10m_bio_17&quot; &quot;wc2.1_10m_bio_18&quot; &quot;wc2.1_10m_bio_19&quot;</code></pre>
<pre class="r"><code>names(clim_fut)</code></pre>
<pre><code>##  [1] &quot;bio01&quot; &quot;bio02&quot; &quot;bio03&quot; &quot;bio04&quot; &quot;bio05&quot; &quot;bio06&quot; &quot;bio07&quot; &quot;bio08&quot; &quot;bio09&quot;
## [10] &quot;bio10&quot; &quot;bio11&quot; &quot;bio12&quot; &quot;bio13&quot; &quot;bio14&quot; &quot;bio15&quot; &quot;bio16&quot; &quot;bio17&quot; &quot;bio18&quot;
## [19] &quot;bio19&quot;</code></pre>
<pre class="r"><code># In this case, let&#39;s keep the names of the future climate layers
names(clim) &lt;- names(clim_fut)</code></pre>
<p>You can also write <code>SpatRaster</code> objects to file:</p>
<pre class="r"><code>terra::writeRaster(clim,filename=&#39;data/bioclim_global_res10.tif&#39;)
terra::writeRaster(clim_fut,filename=&#39;data/bioclim_fut_global_res10.tif&#39;)</code></pre>
</div>
</div>
<div id="land-cover-data" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Land cover data</h1>
<p>The <code>geodata</code> package also offers access to other
environmental data useful for species distribution modelling, for
example soil (<code>?geodata::soil_world</code>) and land cover data
(<code>?geodata::landcover</code>).</p>
<p>The land cover data are derived from the ESA WorldCover data set (<a
href="https://esa-worldcover.org/en"
class="uri">https://esa-worldcover.org/en</a>) that “provides a new
baseline global land cover product at 10 m resolution for 2020 based on
Sentinel-1 and 2 data”. The <code>geodata</code> package offers the
fractional cover at 30-seconds spatial resolution (c. 1 km at the
equator). For illustration, let`s download tree cover globally.</p>
<pre class="r"><code># Download fractional tree cover at 30-sec resolution:
# Please note that you have to set download=T if you haven&#39;t downloaded the data before:
trees_30sec &lt;- geodata::landcover(var=&#39;trees&#39;, path=&#39;data&#39;, download=F)

# map the tree cover
plot(trees_30sec)</code></pre>
<p><img src="b2_EnvData_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Above, we used climate data at 10-min spatial resolution. To obtain
the same spatial resolution for the land cover, we have to aggregate the
<code>SpatRaster</code> object.</p>
<pre class="r"><code># Aggregate tree cover to 10-min spatial resolution
trees_10min &lt;- terra::aggregate(trees_30sec, fact=20, fun=&#39;mean&#39;)

# Map the 10-min tree cover
plot(trees_10min)</code></pre>
<p><img src="b2_EnvData_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<p>Now that our tree cover data and climate data are at the same spatial
resolution, we can stack them into a multi-layer object. But caution,
the <code>SpatRaster</code> objects also need to have the same spatial
extent.</p>
<pre class="r"><code># This produces an error that spatial extents do not match:
env_cur &lt;- c(clim, trees_10min)</code></pre>
<pre><code>## Error: [rast] extents do not match</code></pre>
<pre class="r"><code># Which SpatRaster object has the larger extent?
terra::ext(clim)</code></pre>
<pre><code>## SpatExtent : -180, 180, -90, 90 (xmin, xmax, ymin, ymax)</code></pre>
<pre class="r"><code>terra::ext(trees_10min)</code></pre>
<pre><code>## SpatExtent : -180, 179.99999999999, -59.999999999996, 84 (xmin, xmax, ymin, ymax)</code></pre>
<pre class="r"><code># As the climate data have the larger extent, we now have to &quot;extend&quot; our land cover extent
terra::extend(trees_10min, clim)</code></pre>
<pre><code>## class       : SpatRaster 
## dimensions  : 1080, 2160, 1  (nrow, ncol, nlyr)
## resolution  : 0.1666667, 0.1666667  (x, y)
## extent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## coord. ref. : lon/lat WGS 84 (EPSG:4326) 
## source(s)   : memory
## name        : trees 
## min value   :     0 
## max value   :     1</code></pre>
<pre class="r"><code># Produce the multi-layer environmental data object with matching extents:
env_cur &lt;- c(clim, terra::extend(trees_10min, clim))</code></pre>
</div>
<div id="joining-species-and-environmental-data" class="section level1"
number="3">
<h1><span class="header-section-number">3</span> Joining species and
environmental data</h1>
<p>Last, we can join our species and environmental data. Such joined
species-environment data later serve as input to our species
distribution models.</p>
<pre class="r"><code># Load our previously saved species data:
load(file=&#39;data/gbif_shrew_cleaned.RData&#39;)</code></pre>
<p>When we have coordinate data, as we have in the GBIF data, we can use
these coordinates to “pierce” through <code>SpatRaster</code> layers.
That’s one of the easiest ways to extract relevant environmental data
for our species records. However, as a very first step we have to decide
which GBIF information should be retained in our data set.</p>
<pre class="r"><code># The GBIF data contain a lot of columns that we probably don&#39;t need:
head(gbif_shrew_cleaned)</code></pre>
<pre class="r"><code># I suggest to keep the following columns for now:
gbif_shrew2 &lt;- gbif_shrew_cleaned[,
    c(&quot;key&quot;, &quot;scientificName&quot;, &quot;decimalLatitude&quot;, &quot;decimalLongitude&quot;, &quot;basisOfRecord&quot;, &quot;speciesKey&quot;, &quot;species&quot;, &quot;year&quot;)]

# We can extract the environmental data for the GBIF coordinates.
# Coordinates are always provided as x/y format, in our case lon/lat.
# We also extract the cellnumbers as this allows checking for duplicates later.
head(terra::extract(x = env_cur, 
    y = data.frame(gbif_shrew2[,c(&#39;decimalLongitude&#39;,&#39;decimalLatitude&#39;)]), cells=T ))</code></pre>
<pre><code>##   ID    bio01    bio02    bio03    bio04    bio05    bio06    bio07    bio08
## 1  1 6.505573 8.508604 33.53277 649.9034 19.95200 -5.42200 25.37400 14.46612
## 2  2 1.040729 6.794708 31.33224 555.2625 12.77975 -8.90625 21.68600  8.04600
## 3  3 4.859771 7.676000 30.56037 658.7612 18.34825 -6.76925 25.11750 13.04246
## 4  4 4.533604 7.417666 31.64466 605.9841 17.16425 -6.27625 23.44050 12.00492
## 5  5 4.533604 7.417666 31.64466 605.9841 17.16425 -6.27625 23.44050 12.00492
## 6  6 3.988135 7.437687 32.27148 590.9376 16.74625 -6.30100 23.04725 11.39575
##        bio09     bio10     bio11 bio12 bio13 bio14     bio15 bio16 bio17 bio18
## 1 -0.3784584 14.466125 -1.351333  1380   188    75 32.609791   522   255   522
## 2 -5.0278749  8.065542 -5.027875  1610   163    87 19.089666   482   298   476
## 3 -2.9991250 13.042459 -2.999125  1027   133    43 37.858047   381   136   381
## 4 -2.5863333 12.004916 -2.586333  1261   166    68 33.134533   476   217   476
## 5 -2.5863333 12.004916 -2.586333  1261   166    68 33.134533   476   217   476
## 6 -2.3434584 11.395750 -2.687667  1146   110    83  8.129628   313   267   313
##   bio19     trees   cell
## 1   261 0.7108175 547640
## 2   298 0.2521183 562734
## 3   136 0.7270582 564914
## 4   217 0.6381673 551946
## 5   217 0.6381673 551946
## 6   279 0.3275670 562727</code></pre>
<pre class="r"><code># Finally, we put species and environmental data into the same data frame:
gbif_shrew2 &lt;- cbind(gbif_shrew2, terra::extract(x = env_cur, y = data.frame(gbif_shrew2[,c(&#39;decimalLongitude&#39;,&#39;decimalLatitude&#39;)]), cells=T ))</code></pre>
<p>We now have to inspect the data again to see whether we have any
missing values or any other issues.</p>
<pre class="r"><code>summary(gbif_shrew2)</code></pre>
<p>Because we superimposed an arbitrary resolution now when joining the
GBIF and environmental data, we could potentially have multiple records
in a single raster cell. As we have extracted the cell numbers from the
<code>SpatRaster</code> object, checking for duplicates is very
simple.</p>
<pre class="r"><code># Check for duplicates - how many duplicates?
sum(duplicated(gbif_shrew2$cell))</code></pre>
<pre><code>## [1] 209</code></pre>
<pre class="r"><code># Only retain non-duplicated cells
gbif_shrew_env &lt;- gbif_shrew2[!duplicated(gbif_shrew2$cell),]

save(gbif_shrew_env, gbif_shrew_cleaned,file=&#39;data/gbif_shrew_cleaned.RData&#39;)</code></pre>
</div>
<div id="homework-prep" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Homework prep</h1>
<p>As homework, solve the exercises in the blue box below. For the
homework, you may need some SpatRaster objects that you should not
forget to save to file.</p>
<pre class="r"><code># Write terra objects to file:
terra::writeRaster(trees_10min,filename=&#39;data/trees_10min.tif&#39;)</code></pre>
<div class="alert alert-info">
<p><em><strong>Exercise:</strong></em></p>
<ul>
<li>Choose another climate scenario, download the data and create two
new data sets merging the GBIF data for your own species (from practical
b1) with each of the climate scenarios, respectively.</li>
<li>Choose another land cover class, download the data and aggregate to
the appropriate spatial resolution. Merge the GBIF data for your own
species (from practical b1) with the current climate and land cover
data.</li>
</ul>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Bakx2019" class="csl-entry">
Bakx, T. R. M., Z. Koma, A. C. Seijmonsbergen, and W. D. Kissling. 2019.
<span>“Use and Categorization of Light Detection and Ranging Vegetation
Metrics in Avian Diversity and Species Distribution Research.”</span>
<em>Diversity and Distributions</em> 25 (7): 1045–59. <a
href="https://doi.org/10.1111/ddi.12915">https://doi.org/10.1111/ddi.12915</a>.
</div>
<div id="ref-Hijmans2005" class="csl-entry">
Hijmans, R. J., S. E. Cameron, J. L. Parra, P. G. Jones, and A. Jarvis.
2005. <span>“Very High Resolution Interpolated Climate Surfaces for
Global Land Areas.”</span> <em>International Journal of Climatology</em>
25 (15): 1965–78. <a
href="https://doi.org/10.1002/joc.1276">https://doi.org/10.1002/joc.1276</a>.
</div>
<div id="ref-Karger2017" class="csl-entry">
Karger, D. N., O. Conrad, J. Boehner, T. Kawohl, H. Kreft, R. Wilber
Soria-Auza, N. E. Zimmermann, H. P. Linder, and M. Kessler. 2017.
<span>“Climatologies at High Resolution for the Earth’s Land Surface
Areas.”</span> <em>Scientific Data</em> 4 (September): 170122.
</div>
</div>
</div>

<!DOCTYPE html>
<html>

<br>
<hr />
<div id="footer">
<p>Damaris Zurell 2022 <a href="http://creativecommons.org/licenses/by/4.0/" >(CC BY 4.0)</a>.  </p>
</div>

</html>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
